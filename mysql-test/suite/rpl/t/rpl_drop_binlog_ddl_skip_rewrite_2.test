#
# PS-7526 : Unexpected quoting and dropping of comments in DROP TABLE commands
# This is related to the PXC-specific fix f4e7fe1a0196b0482938aa1e340b8f226cd2c35d
# Fix DROP TABLE binlogging issue
#

--source include/have_util_sed.inc
--source include/have_grep.inc
--source include/have_binlog_format_row.inc
--source include/rpl/init_source_replica.inc

# Create a few tables.
CREATE TABLE t1 (a INT);
CREATE TABLE t2 (a INT);
CREATE TABLE t3 (a INT);
CREATE TABLE t4 (a INT);

--source include/rpl/sync_to_replica.inc
--source include/rpl/connection_source.inc

# Save the binlog position before the test.
--let $MYSQLD_DATADIR= `SELECT @@datadir`
--let $binlog_fullpath= $MYSQLD_DATADIR/master-bin.000001
--let $binlog_position= query_get_value("SHOW BINARY LOG STATUS", Position, 1)

# Set the necessary variables used by the mysqlbinlog.inc
--let $mysqlbinlog_skip_binlog_statements= 1
--let $mysqlbinlog_capture_output = 1

--echo
--echo #
--echo # Test-1: Dropping tables from the connection which has
--echo #         binlog_ddl_skip_rewrite=ON
--echo #

SET binlog_ddl_skip_rewrite = ON;

--let $query = DROP /* comment1 */ TABLE t1
--eval $query

# Verify that the above DROP command is logged with comments.
--let $mysqlbinlog_pipe= | $GREP '^DROP' | $GREP 'comment1'
--source include/rpl/mysqlbinlog.inc

--echo Executed query: $query
--echo Logged query: $result

# Assert that the query is logged with comments
--assert (`SELECT '$result' = '$query'`)

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t1 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP .* t1' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Assert that value of @@binlog_ddl_skip_rewrite is also sent with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=1*//*!*/;"`)

--echo
--echo #
--echo # Test-2: Dropping tables from the connection which has
--echo #         binlog_ddl_skip_rewrite=ON
--echo #

# Change the connection and drop a few tables
--source include/rpl/connection_source1.inc

# Assert that binlog_ddl_skip_rewrite = OFF
--assert (`SELECT @@binlog_ddl_skip_rewrite = 'OFF'`)

# Save the binlog position.
--let $binlog_position= query_get_value("SHOW BINARY LOG STATUS", Position, 1)

--let $query = DROP /* comment2 */ TABLE t2
--eval $query

# Verify that the above DROP command is logged without comments.
--let $mysqlbinlog_pipe= | $GREP '^DROP' | $GREP 'generated'
--source include/rpl/mysqlbinlog.inc

--echo Executed query: $query
--echo Logged query: $result

# Assert that executed query is different from logged query.
--assert (`SELECT '$result' != '$query'`)

# Assert that rewritten query is logged in the binary log.
--assert (`SELECT  0 != LOCATE("generated by server", "$result")`)

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t2 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP TABLE .*t2' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Since the value of @@binlog_ddl_skip_rewrite is 0 for the second DROP TABLE,
# assert that value of @@binlog_ddl_skip_rewrite is also sent along with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=0*//*!*/;"`)

--echo
--echo #
--echo # Test-3: Continue dropping tables from the connection which has
--echo #         binlog_ddl_skip_rewrite=ON
--echo #

--source include/rpl/connection_source.inc
--let $binlog_position= query_get_value("SHOW BINARY LOG STATUS", Position, 1)

--let $query = DROP /* comment3 */ TABLE t3
--eval $query

--let $mysqlbinlog_pipe= | $GREP '^DROP' | $GREP 'comment3'
--source include/rpl/mysqlbinlog.inc

--echo Executed query: $query
--echo Logged query: $result

# Assert that executed query is different from logged query.
--assert (`SELECT '$result' = '$query'`)

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t3 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP .* t3' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Assert that value of @@binlog_ddl_skip_rewrite is also sent with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=1*//*!*/;"`)

--echo
--echo #
--echo # Test-4: Dropping tables from the connection which has
--echo #         binlog_ddl_skip_rewrite=OFF
--echo #

# Disable binlog_ddl_skip_rewrite and drop a table.
--let $binlog_position= query_get_value("SHOW BINARY LOG STATUS", Position, 1)
SET binlog_ddl_skip_rewrite = OFF;

--let $query = DROP /* comment4 */ TABLE t4;
--eval $query

# Verify that the above DROP command is logged without comments.
--let $mysqlbinlog_pipe= | $GREP '^DROP' | $GREP 'generated'
--source include/rpl/mysqlbinlog.inc

--echo Executed query: $query
--echo Logged query: $result

# Assert that executed query is different from logged query.
--assert (`SELECT '$result' != '$query'`)

# Assert that rewritten query is logged in the binary log.
--assert (`SELECT  0 != LOCATE("generated by server", "$result")`)

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t4 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP TABLE .*t4' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Since the value of @@binlog_ddl_skip_rewrite is 0 for the fourth DROP TABLE,
# assert that value of @@binlog_ddl_skip_rewrite is also sent along with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=0*//*!*/;"`)

# Display the contents of binary logs of both source and replica servers.
--source include/rpl/deprecated/show_binlog_events.inc
--source include/rpl/sync_to_replica.inc
--source include/rpl/deprecated/show_binlog_events.inc

--echo
--echo #
--echo # Test-5: Binlog replay
--echo #

--source include/rpl/connection_source.inc

--let $MYSQLD_DATADIR= `SELECT @@datadir`
--let $mysqlbinlog_pipe=
--let $binlog_fullpath=
--let $binlog_position=

--let $MYSQLBINLOG_OUTFILE=$MYSQLTEST_VARDIR/tmp/ps_7526_mysqlbinlog.sql
--let $mysqlbinlog_parameters= --result-file=$MYSQLBINLOG_OUTFILE --local-load=$MYSQLTEST_VARDIR/tmp/ $MYSQLD_DATADIR/master-bin.000001
--let $WAIT_COUNT=6000

--echo # Dump the binlog events into a file.
--source include/rpl/mysqlbinlog.inc


# Clear all binary logs on replica server.
--source include/rpl/connection_replica.inc
--source include/rpl/stop_replica.inc
RESET BINARY LOGS AND GTIDS;
--source include/rpl/start_replica.inc

--echo # Perform the replay.
--exec $MYSQL_SLAVE -c < $MYSQLBINLOG_OUTFILE


--source include/rpl/deprecated/show_binlog_events.inc

# Verify that @@session.binlog_ddl_skip_rewrite is written on replica server's binary log as well.
--let $MYSQLD2_DATADIR= `SELECT @@datadir`
--let $binlog_fullpath= $MYSQLD2_DATADIR/slave-bin.000001
--let $binlog_position= query_get_value("SHOW BINARY LOG STATUS", Position, 1)

# Set the necessary variables used by the mysqlbinlog.inc
--let $mysqlbinlog_skip_binlog_statements= 1
--let $mysqlbinlog_capture_output = 1
--let $mysqlbinlog_parameters=

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t1 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP .* t1' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Assert that value of @@binlog_ddl_skip_rewrite is also sent with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=1*//*!*/;"`)

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t2 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP TABLE .*t2' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Since the value of @@binlog_ddl_skip_rewrite is 0 for the second DROP TABLE,
# assert that value of @@binlog_ddl_skip_rewrite is also sent along with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=0*//*!*/;"`)

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t3 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP .* t3' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Assert that value of @@binlog_ddl_skip_rewrite is also sent with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=1*//*!*/;"`)

# Verify that the value of @@binlog_ddl_skip_rewrite is also sent with the DROP TABLE t4 query.
--let $binlog_position=
--let $mysqlbinlog_pipe= | $GREP 'DROP TABLE .*t4' -B1 | $GREP 'binlog_ddl_skip_rewrite'
--source include/rpl/mysqlbinlog.inc

--echo Output: $result

# Since the value of @@binlog_ddl_skip_rewrite is 0 for the fourth DROP TABLE,
# assert that value of @@binlog_ddl_skip_rewrite is also sent along with the query.
--assert (`SELECT '$result' = "/*!80026 SET @@session.binlog_ddl_skip_rewrite=0*//*!*/;"`)

# Cleanup
--let $mysqlbinlog_pipe=
--let $binlog_fullpath=
--let $binlog_position=
--remove_file $MYSQLBINLOG_OUTFILE

--source include/rpl/deinit.inc
