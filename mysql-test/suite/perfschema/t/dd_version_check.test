
--source include/have_debug.inc

--disable_query_log

--disable_warnings
drop table if exists test.pfs_published_schema;
drop table if exists test.pfs_check_table;
drop procedure if exists test.pfs_check_proc;
--enable_warnings

--echo "Checking the data dictionary properties ..."

SET SESSION debug= '+d,skip_dd_table_access_check';
SELECT SUBSTRING_INDEX(SUBSTRING(properties, LOCATE('PS_VERSION', properties), 30), ';', 1)
  into @actual_dd_version_tag
  FROM mysql.dd_properties;
SET SESSION debug= '-d,skip_dd_table_access_check';

SELECT @actual_dd_version_tag as "DATA DICTIONARY TAG";

SELECT SUBSTRING(@actual_dd_version_tag, 12) into @actual_dd_version;
SELECT @actual_dd_version as "DATA DICTIONARY VERSION";

SET @old_group_concat_max_len = @@group_concat_max_len;

# We need 1700 rows of varchar(64) concatenated
SET group_concat_max_len = 200000;

create table test.pfs_published_schema
  (version varchar(20) not null,
   pfs_dd_version integer not null,
   signature varchar(64) not null,
   primary key (version),
   unique key(pfs_dd_version));

#
# MAINTAINER:
#
# ONCE A RELEASE IS PUBLISHED,
# DO NOT EVER CHANGE THE SIGNATURES HERE.
#
# The whole point of this MTR test script is that
# it will fail if any change to the performance schema
# database structure is detected, acting as a fail safe.
#
# If a change was intended, then:
# - (a) Go in storage/perfschema/pfs_dd_version.h,
# find the declaration of variable PFS_DD_VERSION,
# and create a new version number for this release
# - (b) Add a row in table test.pfs_published_schema
# for the new schema published, using the new PFS_DD_VERSION
# and the signature of the new schema.
#
# (a) will ensure that upgrades from old releases
# will notice the schema change, and upgrade
# the performance_schema structure in the data dictionary accordingly.
# (b) will ensure this test pass again without the SIGNAL complaining.
#
# BEWARE, failure to do (a) when doing (b) alone
# **WILL** result in broken upgrades,
# with a server binary using a new table definition
# in the code and an old, different, table definition
# in the data dictionary found on disk.
#
# This test is designed to be a reminder to do (a)
# by detecting differences in (b)
#
# If you fail to properly update PFS_DD_VERSION,
# git blame will find you.
#

# Keeping track of all signatures published in GA ...

insert into test.pfs_published_schema
 values("MySQL 8.0.17", 80017,
        "b77ece4deaa3c4676d817ed98c3cc33f5b1a08a001bf610a7d02fb52a42b613d");

insert into test.pfs_published_schema
 values("MySQL 8.0.172", 800172,
        "4b2535cee3a558d09b93caaa1fe9021da9e758ffcacd0922bea81ae9799175dc");

insert into test.pfs_published_schema
 values("MySQL 8.0.18", 80018,
        "1d6747d842bb2483c860cd7b28e886bdc6111ff61fd6b4d07e367aa7b3e9d9bf");

insert into test.pfs_published_schema
 values("MySQL 8.0.19", 80019,
        "f58dba20c4234c34cedfcacd3b9a295dcac77a09b79d5f41d5f740878f272d4d");

insert into test.pfs_published_schema
 values("MySQL 8.0.20", 80020,
        "a9aa0ab4a94ca91622145d735e60bbb03577616970351032d3194d8bfd7a69c7");

insert into test.pfs_published_schema
 values("MySQL 8.0.21", 80021,
        "112972e1f7d2b3a351a14979ecc3b419efc81e79dc029078a3a94955be218e5a");

insert into test.pfs_published_schema
 values("MySQL 8.0.22", 80022,
        "55f21a1c75161f414bb75eb0f46c24becf15232dcf3938d4c80bc3361ecdedea");

insert into test.pfs_published_schema
 values("MySQL 8.0.23", 80023,
        "6f3e7fc656953ea433e9c857619a3d5cb252bfc068291657c4b56acb7ef012e1");

insert into test.pfs_published_schema
 values("MySQL 8.0.24", 80024,
        "223d896eddc7fc8b25b622edbc714a3493ceffe4dd694595c833e693e19db41f");

insert into test.pfs_published_schema
 values("MySQL 8.0.25", 80025,
        "2c0f18a287586e591cf58a670c0768c72cf76b571173e7008e58fb59983fbd1f");

insert into test.pfs_published_schema
 values("MySQL 8.0.27", 80027,
        "69d5f4536bc649b4a198a5d135c1619817889aa9eae4a7d1c7d8f0e06d89a79f");

insert into test.pfs_published_schema
 values("MySQL 8.0.28", 80028,
        "493bc6b273f75ba7ace80a626a940757e2353dffabd52b6bde9781c938a2edcb");

insert into test.pfs_published_schema
 values("MySQL 8.0.29", 80029,
        "73a49507e32a69a288febb39895e45da17f9aa7409146431a4d1ee5d4639aebc");

insert into test.pfs_published_schema
 values("MySQL 8.0.30", 80030,
        "611d5a5a1e863c674f20a6afa078525c11b5b175dcb5b6537e1755e7923abe55");

insert into test.pfs_published_schema
 values("MySQL 8.0.31", 80031,
        "3f3b1274f3924c5874cbe6dd331ab14217ec89ff0b378fef2305c1d7e1918630");

insert into test.pfs_published_schema
 values("MySQL 8.0.32", 80032,
        "556baad25ce27574fea75370799eaca7877291d4b7b54c36e6ce54017bb4e927");

insert into test.pfs_published_schema
 values("MySQL 8.0.33", 80033,
        "1182e14dbd5a25625152b84217f967e8733fc599efbb6e7f1e193eb3bc083123");

insert into test.pfs_published_schema
 values("MySQL 8.2.0", 80200,
        "566f78af08ea40a489c9d7ccb0f398896f36d5bee49f621680b0fdf382660da4");

# MySQL 8.3.0 was incorrectly published with PFS_DD_VERSION 80200,
# which is a bug.
# The tooling now detects this, to prevent similar bugs:
#
# --error ER_DUP_ENTRY
# insert into test.pfs_published_schema
#  values("MySQL 8.3.0", 80200,
#         "This should have been caught in 8.3.0");

# Correct entry
insert into test.pfs_published_schema
 values("MySQL 8.3.0", 80300,
        "e76782448cff7ad04f95786b1eaf47604c50678d28ac9cdad3e57bbe84bcee93");

create table test.pfs_check_table
  (id int NOT NULL AUTO_INCREMENT,
   t text NOT NULL,
   row_hash varchar(64) default null,
   PRIMARY KEY (id));

delimiter $$;

create procedure test.pfs_check_proc(actual_dd_version integer)
begin
  declare whole_schema longtext;
  declare max_length int;
  declare found_signature varchar(64);
  declare found_version varchar(20);
  declare found_dd_version int;

  insert into test.pfs_check_table(t)
    select concat(CATALOG_NAME, "-",
                  SCHEMA_NAME, "-",
                  DEFAULT_CHARACTER_SET_NAME, "-",
                  DEFAULT_COLLATION_NAME, "-",
                  ifnull(SQL_PATH, "NULL"))
    from INFORMATION_SCHEMA.SCHEMATA
    where SCHEMA_NAME = "performance_schema";

  insert into test.pfs_check_table(t)
    select concat(TABLE_CATALOG, "-",
                  TABLE_SCHEMA, "-",
                  TABLE_NAME, "-",
                  TABLE_TYPE, "-",
                  ENGINE, "-",
                  VERSION, "-",
                  ROW_FORMAT, "-",
                  ifnull(AUTO_INCREMENT, "no_auto_increment"), "-",
                  ifnull(TABLE_COLLATION, "no_collation"), "-",
                  ifnull(CREATE_OPTIONS, "no_create_options"), "-",
                  ifnull(TABLE_COMMENT, "no_table_comments"))
    from INFORMATION_SCHEMA.TABLES
    where TABLE_SCHEMA = "performance_schema"
    order by TABLE_NAME;

  insert into test.pfs_check_table(t)
    select concat(TABLE_CATALOG, "-",
                  TABLE_SCHEMA, "-",
                  TABLE_NAME, "-",
                  COLUMN_NAME, "-",
                  ORDINAL_POSITION, "-",
                  ifnull(COLUMN_DEFAULT, "no_default"), "-",
                  IS_NULLABLE, "-",
                  COLUMN_TYPE, "-",
                  ifnull(CHARACTER_SET_NAME, "no_charset"), "-",
                  ifnull(COLLATION_NAME, "no_collation"), "-",
                  ifnull(COLUMN_COMMENT, "no_comment"))
    from INFORMATION_SCHEMA.COLUMNS
    where TABLE_SCHEMA = "performance_schema"
    order by TABLE_NAME, ORDINAL_POSITION;

  insert into test.pfs_check_table(t)
    select concat(TABLE_CATALOG, "-",
                  TABLE_SCHEMA, "-",
                  TABLE_NAME, "-",
                  NON_UNIQUE, "-",
                  INDEX_SCHEMA, "-",
                  INDEX_NAME, "-",
                  SEQ_IN_INDEX, "-",
                  COLUMN_NAME, "-",
                  NULLABLE, "-",
                  INDEX_TYPE, "-",
                  COMMENT)
    from INFORMATION_SCHEMA.STATISTICS
    where TABLE_SCHEMA = "performance_schema"
    order by TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;

/*
  There is a lot of data to crunch,
  doing an intermediate checksum by row.
*/

  update test.pfs_check_table
    set row_hash = sha2(t, 256);

/*
  And then doing a checksum of all rows.
*/

  select group_concat(row_hash order by id)
    from test.pfs_check_table
    into whole_schema;

  select length(whole_schema) into max_length;

  if (max_length = @@group_concat_max_len)
  then
    signal sqlstate "50000" set message_text = "Failed to check, whole_schema string truncated";
  end if;

  select SHA2(whole_schema, 256) into found_signature;

  select version, pfs_dd_version
         into found_version, found_dd_version
    from test.pfs_published_schema
    where signature = found_signature;

  if found_version is null
  then
    begin
      /* Limitation on SIGNAL */
      declare full_msg text;

      /*
        Booby trap: some people do not analyze test failures and
        blindly mtr --record a test to make it 'pass'.
        Make sure, by using now(), that this will not happen.
        See the comments in the MAINTAINER section of this test.
      */

      select "YOU MUST READ THE MAINTAINER NOTES IN THIS TEST."
        as MAINTAINER_ACTION_NEEDED, NOW() as "NOW";

      select concat("Unknown signature ",
                    found_signature,
                    ", fix PFS_DD_VERSION now (",
                    now(),
                    ")") into full_msg;

      signal sqlstate "50000" set message_text = full_msg;
    end;
  end if;

  if (actual_dd_version != found_dd_version)
  then
    begin
      declare full_msg text;

      /*
        Booby trap: actually verify that the PFS_DD_VERSION
        declared in table test.pfs_published_schema corresponds to reality,
        that is, that is corresponds to the PS_VERSION
        contained in the data dictionary on disk.
      */

      select "YOU MUST READ THE MAINTAINER NOTES IN THIS TEST."
        as MAINTAINER_ACTION_NEEDED, NOW() as "NOW";

      select concat("Incoherent PFS_DD_VERSION ",
                    found_dd_version,
                    ", fix PFS_DD_VERSION now (",
                    now(),
                    ")") into full_msg;

      signal sqlstate "50000" set message_text = full_msg;
    end;
  end if;

  select concat("The tables in the performance_schema were last changed in ",
                found_version, ", with a PFS_DD_VERSION = ",
                found_dd_version) as "CHECK STATUS";

end
$$

delimiter ;$$

--echo "Checking the performance schema database structure ..."

call test.pfs_check_proc(@actual_dd_version);

# Debug
# select count(*) from test.pfs_check_table;

SET group_concat_max_len = @old_group_concat_max_len;

drop table test.pfs_published_schema;
drop table test.pfs_check_table;
drop procedure test.pfs_check_proc;

--enable_query_log
