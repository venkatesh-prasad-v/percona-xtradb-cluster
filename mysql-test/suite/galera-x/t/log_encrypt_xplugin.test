#------------------------------------------------------------------------------
# InnoDB transparent encryption on redo log and undo log using xplugin
#------------------------------------------------------------------------------

--source include/have_util_sed.inc
--source include/galera_cluster.inc
--source include/no_valgrind_without_big.inc
--source include/have_innodb_max_16k.inc
--source include/have_mysqlx_plugin.inc
--source include/have_component_keyring_file.inc


# Servers are already started with keyring component loaded.
# Use node_2 as it is easier to restart it.
--connection node_2

# Create a table with encryption, should fail since keyring is not
# loaded

let $old_innodb_file_per_table = `SELECT @@innodb_file_per_table`;
let $old_innodb_redo_log_encrypt = `SELECT @@innodb_redo_log_encrypt`;
let $old_innodb_undo_log_encrypt = `SELECT @@innodb_undo_log_encrypt`;

SELECT @@global.innodb_redo_log_encrypt;
SELECT @@global.innodb_undo_log_encrypt;

--let $dont_reset_global_status_variables= 1
--source include/xplugin_reset_and_wait.inc

--write_file $MYSQL_TMP_DIR/log_encrypt_xplugin_test.tmp
-->sql
SELECT @@global.innodb_redo_log_encrypt;
SET GLOBAL innodb_redo_log_encrypt = 1;
SELECT @@global.innodb_redo_log_encrypt;
SET GLOBAL innodb_undo_log_encrypt = 1;
SELECT @@global.innodb_undo_log_encrypt;
DROP DATABASE IF EXISTS tde_db;
CREATE DATABASE tde_db;
USE tde_db;
CREATE TABLE tde_db.t_encrypt(c2 INT NOT NULL,c3 LONGBLOB) ENCRYPTION="Y"  ENGINE = InnoDB;
CREATE TABLE tde_db.t_non_encrypt(c2 INT NOT NULL,c3 LONGBLOB ) ENGINE = InnoDB;
START TRANSACTION;
INSERT INTO tde_db.t_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
INSERT INTO tde_db.t_encrypt SELECT c2,c3 FROM tde_db.t_encrypt;
INSERT INTO tde_db.t_encrypt SELECT c2,c3 FROM tde_db.t_encrypt;

INSERT INTO tde_db.t_non_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
INSERT INTO tde_db.t_non_encrypt SELECT c2,c3 FROM tde_db.t_non_encrypt;
INSERT INTO tde_db.t_non_encrypt SELECT c2,c3 FROM tde_db.t_non_encrypt;
COMMIT;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_encrypt;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_non_encrypt;

START TRANSACTION;
INSERT INTO tde_db.t_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
INSERT INTO tde_db.t_encrypt SELECT c2,c3 FROM tde_db.t_encrypt;
INSERT INTO tde_db.t_encrypt SELECT c2,c3 FROM tde_db.t_encrypt;

INSERT INTO tde_db.t_non_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
INSERT INTO tde_db.t_non_encrypt SELECT c2,c3 FROM tde_db.t_non_encrypt;
INSERT INTO tde_db.t_non_encrypt SELECT c2,c3 FROM tde_db.t_non_encrypt;
ROLLBACK;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_encrypt;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_non_encrypt;

SET GLOBAL innodb_redo_log_encrypt = 0;
SELECT @@global.innodb_redo_log_encrypt;
SET GLOBAL innodb_undo_log_encrypt = 0;
SELECT @@global.innodb_undo_log_encrypt;
START TRANSACTION;
INSERT INTO tde_db.t_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
INSERT INTO tde_db.t_non_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
COMMIT;
START TRANSACTION;
INSERT INTO tde_db.t_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
INSERT INTO tde_db.t_non_encrypt(c2,c3) VALUES (1,CONCAT(REPEAT("a",6*512*512)));
ROLLBACK;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_encrypt;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_non_encrypt;


SELECT @@global.innodb_redo_log_encrypt;
SET GLOBAL innodb_redo_log_encrypt = 1;
SELECT @@global.innodb_undo_log_encrypt;
SET GLOBAL innodb_undo_log_encrypt = 1;

SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_encrypt;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_non_encrypt;
-->endsql
EOF

CREATE USER 'x_root'@'localhost' IDENTIFIED WITH 'mysql_native_password';
GRANT ALL ON *.* TO 'x_root'@'localhost' WITH GRANT OPTION;

--sleep 3
# Run from xplugin
--exec $MYSQLXTEST --port=$NODE_XPORT_2 -ux_root --password='' --file=$MYSQL_TMP_DIR/log_encrypt_xplugin_test.tmp 2>&1
--remove_file $MYSQL_TMP_DIR/log_encrypt_xplugin_test.tmp

DROP USER 'x_root'@'localhost';

SELECT @@global.innodb_redo_log_encrypt;
SELECT @@global.innodb_undo_log_encrypt;


--echo # Restarting server with keyring plugin
--let $restart_parameters=
--source ../include/restart_mysqld.inc
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_encrypt;
SELECT c2,SUBSTRING(c3,1,10) FROM tde_db.t_non_encrypt;
DROP DATABASE tde_db;

## Cleanup
--disable_query_log
eval SET GLOBAL innodb_file_per_table=$old_innodb_file_per_table;
eval SET GLOBAL innodb_redo_log_encrypt=$old_innodb_redo_log_encrypt;
eval SET GLOBAL innodb_undo_log_encrypt=$old_innodb_undo_log_encrypt;
--enable_query_log
